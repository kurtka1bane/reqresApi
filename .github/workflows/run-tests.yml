name: Run API Tests with Gradle

on:
  workflow_dispatch:  # –¢–æ–ª—å–∫–æ —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # –®–∞–≥ 1: –ö–ª–æ–Ω–∏—Ä—É–µ–º –∫–æ–¥
      - uses: actions/checkout@v4

      # –®–∞–≥ 2: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Java
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # –®–∞–≥ 3: –î–µ–ª–∞–µ–º gradlew –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
      - name: Make gradlew executable
        run: chmod +x gradlew

      # –®–∞–≥ 4: –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
      - name: Run tests and parse results
        id: run_tests
        run: |
          # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã —Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –æ—Ç—á–µ—Ç–∞
          ./gradlew test --continue || true

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
          if [ ! -d "build/test-results/test" ]; then
            echo "::warning::Test results directory not found!"
            echo "::set-output name=total::0"
            echo "::set-output name=passed::0"
            echo "::set-output name=failed_count::0"
            echo "::set-output name=failed::[]"
            exit 0
          fi

          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python
          sudo apt-get update && sudo apt-get install -y python3

          # Python —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
          python3 <<EOF
          import xml.etree.ElementTree as ET
          import glob
          import json
          import os

          failed_tests = []
          total_count = 0

          # –ò—â–µ–º –≤—Å–µ XML —Ñ–∞–π–ª—ã —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
          for xml_file in glob.glob("build/test-results/test/*.xml"):
              try:
                  tree = ET.parse(xml_file)
                  root = tree.getroot()
                  total_count += int(root.get("tests", 0))

                  for testcase in root.findall(".//testcase"):
                      if testcase.find("failure") is not None:
                          classname = testcase.get("classname", "").split(".")[-1]
                          name = testcase.get("name", "")
                          failed_tests.append(f"{classname}.{name}")
              except Exception as e:
                  print(f"::warning::Error parsing {xml_file}: {str(e)}")

          print(f"::set-output name=total::{total_count}")
          print(f"::set-output name=passed::{total_count - len(failed_tests)}")
          print(f"::set-output name=failed_count::{len(failed_tests)}")
          print(f"::set-output name=failed::{json.dumps(failed_tests)}")
          EOF

      # –®–∞–≥ 5: –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á–µ—Ç–∞ –≤ Telegram
      - name: Send test results to Telegram
        if: always()
        uses: appleboy/telegram-action@v1.0.0
        with:
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          message: |
            üìä *–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤*
            ‚ñ´Ô∏è –í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤: ${{ steps.run_tests.outputs.total || '0' }}
            ‚úÖ –£—Å–ø–µ—à–Ω–æ: ${{ steps.run_tests.outputs.passed || '0' }}
            ‚ùå –£–ø–∞–ª–æ: ${{ steps.run_tests.outputs.failed_count || '0' }}
            ${{ fromJSON(steps.run_tests.outputs.failed_count || '0') > 0 && format('‚ñ´Ô∏è –£–ø–∞–≤—à–∏–µ —Ç–µ—Å—Ç—ã:\n{0}', join(fromJSON(steps.run_tests.outputs.failed || '[]'), '\n‚ñ™Ô∏è ')) || '‚ñ´Ô∏è –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!' }}
            üîó –ó–∞–ø—É—Å–∫: [${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            üì¶ –û—Ç—á—ë—Ç: [–°–∫–∞—á–∞—Ç—å](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/${{ steps.upload_artifacts.outputs.artifact-id }})
          format: "markdown"
          disable_web_page_preview: true