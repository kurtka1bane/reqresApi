name: Run API Tests with Gradle

on:
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # –®–∞–≥ 1: –ö–ª–æ–Ω–∏—Ä—É–µ–º –∫–æ–¥
      - uses: actions/checkout@v4

      # –®–∞–≥ 2: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Java
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # –®–∞–≥ 3: –î–µ–ª–∞–µ–º gradlew –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
      - name: Make gradlew executable
        run: chmod +x gradlew

      # –®–∞–≥ 4: –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã
      - name: Run tests
        run: ./gradlew test

      # –®–∞–≥ 5: –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç—á—ë—Ç—ã
      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: |
            build/reports/tests/
            build/test-results/

      # —à–∞–≥ 6: –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á–µ—Ç–∞ –≤ Telegram
      - name: Send test results to Telegram
        if: always()  # –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–µ—Å—Ç—ã —É–ø–∞–ª–∏
        uses: appleboy/telegram-action@master
        with:
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          message: |
            üìä *–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤ Reqres.in*
            ‚îú‚îÄ –°—Ç–∞—Ç—É—Å: ${{ job.status == 'success' && '‚úÖ –£—Å–ø–µ—à–Ω–æ' || '‚ùå –û—à–∏–±–∫–∞' }}
            ‚îú‚îÄ –ó–∞–ø—É—Å–∫: [${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            ‚îú‚îÄ –í–µ—Ç–∫–∞: ${{ github.ref_name }}
            ‚îî‚îÄ –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã: [–°–∫–∞—á–∞—Ç—å](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts)
          parse_mode: markdown